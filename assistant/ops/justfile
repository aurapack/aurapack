# Detect distro and install dependencies
deps:
	if command -v pacman >/dev/null; then \
		sudo pacman -S --needed --noconfirm mosquitto alsa-utils just base-devel cmake git; \
	elif command -v apt-get >/dev/null; then \
		sudo apt-get update && sudo apt-get install -y mosquitto mosquitto-clients alsa-utils just build-essential cmake git; \
	else \
		echo "Unsupported distro: please install mosquitto, alsa-utils, cmake, git manually."; \
	fi

# Run local MQTT broker (foreground)
dev-broker:
	sudo mosquitto -v

# Subscribe to assistant output topic
test-sub:
	mosquitto_sub -t /assistant/output/text -v

# Publish a sample message to input topic
test-pub:
	mosquitto_pub -t /assistant/input/text -m '{"text":"turn on the light","session_id":"demo"}'

# Build the assistant binary (Go)
build:
	cd ../go && go mod tidy && go build -o ../bin/assistant

# Package release tarball (requires bin/, cfg/, ops/, models/)
package:
	cd .. && VERSION=$$(date +%Y%m%d%H%M%S) && \
	tar czf aurapack-assistant_$${VERSION}.tar.gz cfg ops bin models

# Clean build artifacts
clean:
	rm -rf ../bin/assistant ../go/go.sum

